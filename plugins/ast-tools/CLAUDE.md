# ast-tools

## Purpose
AST-based code search and transformation tools using ast-grep for semantic code analysis and refactoring.

## Key Files

| File | Description |
|------|-------------|
| `.claude-plugin/plugin.json` | Plugin metadata and MCP server configuration |
| `.mcp.json` | MCP server entry point (ast-tools server) |
| `package.json` | Dependencies and build scripts |
| `dist/mcp-server.cjs` | Bundled MCP server (generated by build) |
| `src/tools/ast-grep-search.ts` | AST pattern search implementation |
| `src/tools/ast-grep-replace.ts` | AST pattern replacement implementation |
| `src/mcp/server.ts` | MCP server with stdio transport |
| `scripts/build.mjs` | esbuild bundler script |

## Subdirectories

| Directory | Purpose |
|-----------|---------|
| `src/tools/` | Tool implementations (search, replace) |
| `src/lib/` | Core libraries (language-map, file-finder, module-loader) |
| `src/mcp/` | MCP server implementation |
| `scripts/` | Build scripts |
| `tests/` | Jest tests |
| `dist/` | Build output (gitignored) |

## For AI Agents

### Working In This Directory
- **Build**: `npm run build` (bundles MCP server to dist/mcp-server.cjs)
- **Test**: `npm test` (runs Jest with ESM support)
- **Type Check**: `npm run typecheck`
- **Dependencies**: @ast-grep/napi (optional, graceful degradation if missing)

### Architecture
**Hybrid Structure**: Plugin + Embedded MCP Server
- Plugin metadata in `.claude-plugin/plugin.json`
- MCP server bundled in `dist/mcp-server.cjs`
- Tools: `ast_grep_search`, `ast_grep_replace`
- Transport: stdio (Standard I/O)
- Language Support: 18 languages (JS, TS, Python, Go, Rust, etc.)

### Key Components

**Core Libraries** (`src/lib/`):
- `language-map.ts`: 18 language support, extension → language mapping
- `file-finder.ts`: Recursive file search with exclusions
- `module-loader.ts`: Dynamic @ast-grep/napi loading with graceful degradation

**Tools** (`src/tools/`):
- `ast-grep-search.ts`: Pattern-based code search (252 lines)
  - Zod schema validation
  - Meta-variables support ($VAR, $$$ARGS)
  - Context lines display
  - maxResults limiting
- `ast-grep-replace.ts`: Pattern-based code transformation
  - Meta-variable substitution
  - Dry-run mode (default: true)
  - Reverse-order edits (byte offset preservation)
  - Before/After preview

**MCP Server** (`src/mcp/server.ts`):
- Stdio transport
- ListToolsRequest handler (Zod → JSON Schema conversion)
- CallToolRequest handler (tool execution)
- Error handling

**Build** (`scripts/build.mjs`):
- esbuild bundler
- NODE_PATH resolution banner (finds global @ast-grep/napi)
- Externalizes native modules
- Output: dist/mcp-server.cjs

### Testing Requirements
- Jest with ESM support (`NODE_OPTIONS=--experimental-vm-modules`)
- 9 tests: 7 passing (77% pass rate)
- Test files: `tests/ast-grep-search.test.ts`, `tests/ast-grep-replace.test.ts`

### Common Patterns
- Graceful degradation when @ast-grep/napi unavailable
- Meta-variables: `$NAME` (single), `$$$ARGS` (multiple)
- File exclusions: node_modules, .git, dist, build, __pycache__, .venv
- MCP response format: `{ content: [{ type: "text", text: string }] }`

### Meta-variables Usage
```typescript
// Search
Pattern: "function $NAME($$$ARGS) { $$$BODY }"
Matches: function hello(x, y) { return x + y; }

// Replace
Pattern: "var $NAME = $VALUE"
Replacement: "const $NAME = $VALUE"
Result: var x = 1; → const x = 1;
```

## Dependencies

### Runtime
- `@ast-grep/napi`: ^0.31.0 (optional, graceful degradation)
- `@modelcontextprotocol/sdk`: ^1.0.4 (MCP protocol)
- `zod`: ^3.23.8 (schema validation)

### Development
- `typescript`: ^5.3.3
- `esbuild`: ^0.20.0
- `jest`: ^29.5.0
- `ts-jest`: ^29.1.0
- `@types/jest`: ^29.5.0
- `@types/node`: ^20.0.0

## Build Process

1. **Source**: TypeScript in `src/`
2. **Compile**: tsc (type checking only, no emit)
3. **Bundle**: esbuild → `dist/mcp-server.cjs`
4. **Banner**: Inject NODE_PATH resolution for global modules
5. **External**: @ast-grep/napi, Node.js built-ins

## Known Issues

- 2/9 tests failing (output format mismatches)
- TypeScript warnings: Server class deprecated (MCP SDK)
- Jest ESM support requires NODE_OPTIONS flag

<!-- MANUAL: -->
